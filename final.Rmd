---
title: "final_sna"
author: "Phong Duong, Nienke Visscher, Frederick Sims"
date: "2024-05-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

# Libraries

```{r}
library(tidyverse)
library(igraph)
```

# Import Data

```{r}
data <- read_csv("migration_data.csv") %>% 
  rename(source = "Country Origin Name",
         target = "Country Dest Name",
         migration_2000 = "2000 [2000]") %>% 
  select(source, target, migration_2000) %>% 
  filter(migration_2000 > 0)
data %>% head()
```

```{r}
g <- graph_from_data_frame(data, directed = TRUE) %>% 
  simplify(.)
g
```

```{r}
par(mar=c(0,0,0,0))
plot(g, directed = TRUE, weighted = TRUE,
     edge.arrow.size = 0.2,
     edge.color = adjustcolor("grey30", 0.2),
     vertex.color = ifelse(degree(g) > 10, "orange", "grey50"),
     vertex.size = 4,
     vertex.label = "")
```

# Propagation Simulation

We want to simulate the propagation of information on this network using the SIR model assuming that an infected person can transmit the information with probability β to a susceptible person on the network.

## Epidemic Threshold

a)  Find the theoretical epidemic threshold β for your network for the information to reach a significant number of nodes.

```{r}
mu <- 0.1
betac <- mu*mean(degree(g))/(mean(degree(g)^2))
betac
```

## Simulation

b)  Assuming that randomly-selected 1% of the nodes of your network knows about the information, simulate the SIR model below and above that threshold and plot the number of infected people as a function of β.

```{r}
sim_sir <- function(g,beta,mu,seeds){
  state <- rep(0,vcount(g)) #initial state of the simulation
  state[seeds] <- 1 #infect the seeds
  t <- 0
  table <- data.frame(t=0,inf=seeds)
  while(sum(state==1)>0){
    t <- t + 1
    ## I -> R
    infected <- which(state==1) #get them
    # generate a random value for every infected, if it's < mu, let the node recover.
    state[infected] <- ifelse(runif(length(infected)) < mu,2,1)
    
    ## S -> I
    infected <- which(state==1)
    susceptible <- which(state==0) #get them
    contacts <- as.numeric(unlist(adjacent_vertices(g,infected))) #get the contacts of infected
    contacts <- contacts[contacts %in% susceptible] # get those who are susceptible
    contacts <- contacts[!duplicated(contacts)]
    new_infected <- contacts[runif(length(contacts)) < beta] #infect contacts
    if(length(new_infected)>0){
      state[new_infected] <- 1
      table <- rbind(table,data.frame(t,inf=new_infected))
    }
  }
  table
}
```

### Above Threshold

```{r}
set.seed(230)
# Sample 1% of the network as initial infectious seed
seeds <- sample(1:vcount(g),0.01*vcount(g))
# Generate a simlulation of the SIR model with beta above threshold
realization_at <- sim_sir(g,beta = 0.1,mu=0.1,seeds) 
realization_at
```

```{r}
realization_at <- realization_at %>% 
  group_by(t) %>% summarize(ninf=n()) 
realization_at %>% 
  ggplot(aes(x=t,y=ninf)) + geom_line()
```

### Below threshold

```{r}
set.seed(230)
# Sample 1% of the network as initial infectious seed
seeds <- sample(1:vcount(g),0.01*vcount(g))
# Generate a simlulation of the SIR model with beta below threshold
realization_bt <- sim_sir(g,beta = 0.0002, mu=0.01,seeds) 
realization_bt
```

```{r}
realization_bt <- realization_bt %>% 
  group_by(t) %>% summarize(ninf=n()) 
realization_bt %>% 
  ggplot(aes(x=t,y=ninf)) + geom_line()
```

### Different Betas

```{r}
set.seed(230)
results <- map_dfr(seq(0,0.2,0.005), # beta range
        \(beta){ seeds <- sample(1:vcount(g),vcount(g)*0.01)
        realization <- sim_sir(g,beta,mu,seeds) # make a realization for each beta
        data.frame(beta,ninf=nrow(realization)) # create dataframe row
        })
results %>% ggplot(aes(x=beta,y=ninf))+ geom_point()+
  geom_vline(xintercept = betac,linetype=2)
```

## Better 1% seeds

c)  Choose a β above β~c~. Using centrality, communities or any other metric, find a better set of 1% of seeds in the network so we get more infected people than the random case. Measure the difference of your choice with the random case as:

```{r}
set.seed(230)
beta_at <- 0.1
#target at random
seeds_random <- sample(1:vcount(g),vcount(g)*0.01)
realization_random <- sim_sir(g,beta = beta_at,mu=0.1,seeds_random) %>%
  group_by(t) %>% summarize(ninf=n())
#target by closeness
seeds_closeness <- closeness(g) %>% enframe(name = "inf",value="closeness") %>%
  slice_max(closeness,n= round(vcount(g)*0.01))
realization_closeness <- sim_sir(g,beta = beta_at,mu=0.1,which(V(g)$name == seeds_closeness$inf)) %>%
  group_by(t) %>% summarize(ninf=n())
#target by betweenness
seeds_between <- betweenness(g) %>% enframe(name = "inf",value="betweenness") %>%
  slice_max(betweenness,n= round(vcount(g)*0.01))
realization_between <- sim_sir(g,beta = beta_at,mu=0.1,which(V(g)$name == seeds_between$inf)) %>%
  group_by(t) %>% summarize(ninf=n())
#target using page rank
seeds_pagerank <- page_rank(g)$vector %>% enframe(name = "inf",value="page_rank") %>%
  slice_max(page_rank,n= round(vcount(g)*0.01))
realization_pagerank <- sim_sir(g,beta = beta_at,mu=0.1,which(V(g)$name == seeds_pagerank$inf)) %>%
  group_by(t) %>% summarize(ninf=n())

ggplot() + geom_line(data=realization_random,aes(x=t,y=ninf,col="Target at random"))+
  geom_line(data=realization_closeness,aes(x=t,y=ninf,col="Target by closeness")) +
  geom_line(data=realization_between,aes(x=t,y=ninf,col="Target by betweenness")) +
  geom_line(data=realization_pagerank,aes(x=t,y=ninf,col="Target by page rank"))
```

-   The difference in the total number of infected people

```{r}
realization_random$ninf %>% sum()
realization_between$ninf %>%  sum()
realization_closeness$ninf %>%  sum()
realization_pagerank$ninf %>% sum()
```

-   The difference in the time of the peak of infection (when most infections happen).

```{r}
max(realization_random$ninf)
max(realization_between$ninf)
max(realization_closeness$ninf)
max(realization_pagerank)
```
